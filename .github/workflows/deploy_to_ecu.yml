name: Deploy to ECU

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Permite ejecuci贸n manual

jobs:
  deploy-to-ecu:
    runs-on: self-hosted   # Tu PC Windows
    
    steps:
      - name: Checkout c贸digo
        uses: actions/checkout@v4

      - name: Transferir c贸digo a ECU
        run: |
          Write-Host "Transfiriendo c贸digo a la ECU..."
          scp -r ecu_atx1610 fox@193.147.165.236:/home/fox/
        shell: pwsh

      - name: Compilar en ECU
        run: |
          Write-Host "Compilando en la ECU..."
          ssh fox@193.147.165.236 "cd /home/fox/ecu_atx1610; mkdir -p build; cd build; cmake ..; make -j4"
        shell: pwsh

        shell: pwsh

      - name: Reiniciar ECU
        run: |
          Write-Host "Reiniciando ECU..."
          ssh fox@193.147.165.236 "pkill -9 ecu_atx1610 || true; sleep 2; cd /home/fox/ecu_app/bin; nohup sudo ./ecu_atx1610 > ../logs/ecu_\$(date +%Y%m%d_%H%M%S).log 2>&1 & echo 'ECU reiniciada. PID:' \$!"
        shell: pwsh

      - name: Verificar estado
        run: |
          Write-Host "Verificando estado de la ECU..."
          Start-Sleep -Seconds 5
          ssh fox@193.147.165.236 "if pgrep -x ecu_atx1610 > /dev/null; then echo 'ECU corriendo correctamente'; echo 'PID:' \$(pgrep -x ecu_atx1610); else echo 'ECU no esta corriendo'; exit 1; fi"
        shell: pwsh

      - name: Mostrar logs recientes
        if: always()
        run: |
          Write-Host "Ultimos logs de la ECU:"
          ssh fox@193.147.165.236 "tail -20 /home/fox/ecu_app/logs/ecu_*.log 2>/dev/null | tail -20 || echo 'No hay logs disponibles'"
        shell: pwsh