name: Deploy to ECU (Windows)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- NEW STEP: Test connectivity from GitHub Actions ---
      - name: Test SSH connectivity
        shell: bash
        env:
          ECU_HOST: ${{ secrets.ECU_HOST }}
        run: |
          echo "Testing connectivity to $ECU_HOST on port 22..."
          nc -vz $ECU_HOST 22 || echo "FAILED: GitHub cannot reach your server on port 22"

      # --- Configure SSH Key ---
      - name: Configure SSH key
        shell: pwsh
        env:
          ECU_HOST: ${{ secrets.ECU_HOST }}
          ECU_USER: ${{ secrets.ECU_USER }}
          ECU_KEY: ${{ secrets.ECU_SSH_KEY }}
        run: |
          $sshDir = "$HOME/.ssh"
          if (-not (Test-Path $sshDir)) {
            New-Item -ItemType Directory -Path $sshDir | Out-Null
          }

          $keyPath = "$sshDir/id_ed25519"
          $cleanKey = $env:ECU_KEY -replace "`r", ""
          Set-Content -Path $keyPath -Value $cleanKey -Encoding ascii -NoNewline

          icacls $keyPath /inheritance:r /grant:r "$($env:USERNAME):(R)" | Out-Null

          ssh -o StrictHostKeyChecking=no -i $keyPath "$env:ECU_USER@$env:ECU_HOST" "echo 'Deployment triggered from GitHub Actions'"

      - name: Done
        shell: pwsh
        run: Write-Host "Deployment command executed."
