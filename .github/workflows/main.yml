name: Deploy to ECU

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Permite ejecución manual

jobs:
  deploy-to-ecu:
    runs-on: self-hosted   # Tu PC Windows
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Transferir código a ECU
        run: |
          Write-Host "Transfiriendo código a la ECU..."
          scp -r ecu_atx1610 fox@193.147.165.236:/home/fox/
        shell: pwsh

      - name: Compilar en ECU
        run: |
          Write-Host "Compilando en la ECU..."
          ssh fox@193.147.165.236 "cd /home/fox/ecu_atx1610; mkdir -p build; cd build; cmake ..; make -j4"
        shell: pwsh

      - name: Verificar compilación
        run: |
          Write-Host "Verificando compilación..."
          ssh fox@193.147.165.236 "test -f /home/fox/ecu_atx1610/build/ecu_atx1610 && echo 'Compilación exitosa' || exit 1"
        shell: pwsh

      - name: Instalar en directorio de aplicación
        run: |
          Write-Host "Instalando ejecutable..."
          ssh fox@193.147.165.236 "mkdir -p /home/fox/ecu_app/bin /home/fox/ecu_app/logs"
          ssh fox@193.147.165.236 "cp /home/fox/ecu_atx1610/build/ecu_atx1610 /home/fox/ecu_app/bin/"
          ssh fox@193.147.165.236 "cp /home/fox/ecu_atx1610/scripts/setup_can.sh /home/fox/ecu_app/bin/"
          ssh fox@193.147.165.236 "sed -i 's/\r$//' /home/fox/ecu_app/bin/setup_can.sh"
          ssh fox@193.147.165.236 "chmod +x /home/fox/ecu_app/bin/setup_can.sh"
          ssh fox@193.147.165.236 "chmod +x /home/fox/ecu_app/bin/ecu_atx1610"
          Write-Host "Instalación completada"
        shell: pwsh

          ssh fox@193.147.165.236 "if pgrep -x ecu_atx1610 > /dev/null; then echo 'ECU corriendo correctamente'; echo 'PID:' `$(pgrep -x ecu_atx1610); else echo 'ECU no esta corriendo'; exit 1; fi"
        shell: pwsh

      - name: Mostrar logs recientes
        if: always()
        run: |
          Write-Host "Ultimos logs de la ECU:"
          ssh fox@193.147.165.236 "tail -20 /home/fox/ecu_app/logs/ecu_*.log 2>/dev/null | tail -20 || echo 'No hay logs disponibles'"
        shell: pwsh