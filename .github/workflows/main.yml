name: Deploy to ECU

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Permite ejecución manual

jobs:
  deploy-to-ecu:
    runs-on: self-hosted   # Tu PC Windows
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Transferir código a ECU
        run: |
          Write-Host "Transfiriendo código a la ECU..."
          scp -r ecu_atx1610 fox@193.147.165.236:/home/fox/
        shell: pwsh

      - name: Compilar en ECU
        run: |
          Write-Host "Compilando en la ECU..."
          ssh fox@193.147.165.236 "cd /home/fox/ecu_atx1610; mkdir -p build; cd build; cmake ..; make -j4"
        shell: pwsh

      - name: Verificar compilación
        run: |
          Write-Host "Verificando compilación..."
          ssh fox@193.147.165.236 "test -f /home/fox/ecu_atx1610/build/ecu_atx1610 && echo 'Compilación exitosa' || exit 1"
        shell: pwsh

      - name: Instalar en directorio de aplicación
        run: |
          ssh fox@193.147.165.236 "tail -20 /home/fox/ecu_app/logs/ecu_*.log 2>/dev/null | tail -20 || echo 'No hay logs disponibles'"
        shell: pwsh